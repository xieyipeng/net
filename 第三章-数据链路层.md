# 数据链路层

数据链路层使用的信道主要有以下两种类型：

* 点对点信道
* 广播信道

## 使用点对点信道的数据链路层

### 数据链路和帧

链路是一条无源的点到点的物理线路段，中间没有任何其他交换节点。

数据链路除了物理线路外，还必须有通信协议来控制这些数据的传输，若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

现在最常用的方法就是使用适配器（即网卡）来实现这些硬件和软件。

也有人把链路分为物理链路和逻辑链路，

物理线路就是上面所说的链路，逻辑链路就是上面所说的数据链路，是物理链路加上必要的通信协议。

数据链路层传送的是帧，

### 三个基本问题

1. 封装成帧

   封装成帧就是在一段数据前后分别添加首部和尾部，然后就构成了一个帧确定帧的界限首部和尾部的一个重要作用就是帧定界。

   帧：数据链路层按照具体协议要修比特流装配而成的。

   帧同步是为了使接收方能够从收到的比特流中准确的去别处一帧的开始和结束。

   实现帧同步的方法：

   * 字节计数法：

   * 字符填充法：

   * 比特填充法：

   * 违法编码法：

     曼彻斯特编码和查分曼彻斯特编码属于违法编码法

2. 透明传输

   如果数据中耨个字节的二进制代码恰好和SOH或EOT一样，数据链路层就会错误的找到帧的边界。

   解决的办法：字节填充，发送端在数据链路层在数据中出现控制字符SOH或EOT的前面加上转义字符ESC

3. 差错控制

   1变成0或0变成1。

   差错控制是数据链路层的主要功能之一，但不是数据链路层所特有的功能。在网络层和传输层也都有差错控制功能，只是差错控制对此昂不同。

   在数据链路层传送的帧中，广泛采用的`循环冗余检验，CRC`的检错技术。

   这种检测方法不能确定究竟是哪一个或那几个比特出现了错误。

   要做到可靠传输，就必须加上确认和重传机制。

   `本章介绍的数据链路层协议都是不可靠传输协议`

流量控制：流量控制也不是数据链路层所特有的功能，在其他高层协议中也有流量控制功能

寻址：在点对点式的链路上不存在寻址问题，在多点连接的情况下，必须保证每帧能正确地传送到接受方，而接受方也应该知道发送方的地址。

常用的差错控制方法采用：`自动重发请求，ARQ`技术和`前向纠错技术，FEC`

常用的流量控制方法采用：停等协议和滑动窗口协议。

* 停等协议

  停等协议是最基本最简单的流量控制协议。在源和目标之间的数据流动是由接受方来控制的。

* 滑动窗口

  允许连续发送多个为被确认的帧。

差错控制是检测和纠正错误的机制，通常应付传输差错的办法如下：

* 肯定应答
* 否定应答重发
* 超时重发

这些技术的主要思想就是利用差错检测技术自动对丢失的帧和错误帧请求重发，称之为`自动请求重发，ARQ`，结合流控技术，可以组成三种形式的ARQ协议：

* 停等ARQ

  停等ARQ协议是停等留空技术和自动请求重发合计技术的结合

* 后退N帧ARQ

  是滑动窗口技术和自动请求重发技术的结合

* 选择重发ARQ

  是滑动窗口技术和自动请求重发技术的结合，设置接收窗口像发送窗口一样大，允许将未按顺序到达的数据帧暂存，只是选择性的重发出错或丢失的帧。

差错控制技术：

* 概括地说，传输中的差错都是由噪声所引起的。
* 噪声有两大类，一类是信道所固有的持续存在的随即热噪声，另一类是外界特定的短暂原因造成的冲击噪声。
* 衡量信道质量的一个重要的参数是误码率

奇偶效验码：通过增加冗余位来使得码字中1的个数保持奇数偶数的编码方法。是一种验错码。

* 使用时分为
  * 垂直奇偶效验
  * 水平奇偶效验
  * 水平垂直奇偶效验

`CRC码：称为多项式码，循环冗余效验码`能够检测出数据帧的1位或n位错误，然后丢弃重传，具有良好的检错能力。

在数据后面添加的冗余码称为`帧检验序列，FCS`

FCS和CRC并不等同，CRC是一种常用的检错方法，而FCS是添加在数据后面的冗余码。

HDLC链路结构和操作方式：

HDLC定义了三种类型的站，两种链路配置和三种传输方式。

三种类型站为：

* 主站
* 次站
* 复合站

两种链路配置：

* 非平衡配置
* 平衡配置

三种数据传输方式：

* 正常响应方式
* 异步响应方式
* 异步平衡方式

![PSUi1U.png](https://s1.ax1x.com/2018/06/21/PSUi1U.png)

* 标志字段：

  HDLC用一种特殊的位模式01111110作为标志以确定帧的边界

* 地址字段：

  用于标识从站的地址，用在点对多的链路中，地址通常是8位，也可以采用更长的扩展地址，是8位的整数倍。8位组的第一位表示是否是地址字段的结尾。其余7位组成了扩展地址字段。全为1的8位组表示广播地址。

* HDLC定义了三种帧，信息帧，管理帧，无编号帧。

  * 信息帧（I帧）

    用于实现信息的编号传送，控制字段第一位为0，它具有发送序号N(S)，用于表明所发送的信息帧的序号。只有信息帧才拥有此序号，还有捎带的肯定应答信号N(R)，用于标明预期接收的帧的序号。

  * 管理帧（S帧）

    用于实现流量控制和差错控制，控制字段的前两位为10，只含有接收序号，不包含信息段。

  * 无编号帧（U帧）

    用于链路的控制。

* 信息字段（INFO）

  只有I帧和某些无编号帧含有信息字段，这个字段可含有表示用户数据的任何比特序列，其长度没有规定，但具体的实现往往限定了最大帧长。

* 帧效验序列（FCS）

  FCS中含有除标志字段之外的所有其他字段的效验和。

HDLC帧的类型：

* 信息帧

  信息帧用来承载用户数据外，还包含帧的编号，以及捎带的肯定应答序号。

* 管理帧

  管理帧用于流量和差错的控制。

* 无编号帧

  无编号帧用于链路控制，这类帧不包含编号字段，也不改变信息帧流动的顺序。

  无编号帧按其控制功能分为以下几个子类：

  * 设置数据传输方式的命令和相应帧；
  * 传输信息的命令和相应帧；
  * 用于链路恢复的命令和响应帧；
  * 其他命令和响应帧

## 点对点协议PPP

### PPP协议的特点

对于点对点的链路，目前使用最广泛的数据链路层协议是`PPP，点对点协议`。

* 能控制数据线路的建立。
* 能够对IP地址进行分配和使用。
* 允许同时采用多种网络层协议。
* 能够配置和测试数据链路。
* 能够进行错误检测。
* 有协商选项，能够对网络层的地址和数据压缩等进行协商。

#### PPP协议满足的需求

* 简单
* 封装成帧
* 透明性
* 多种网络层协议
* 多种类型链路
* 差错检测
* 检测连接状态、
* 最大传输单元
* 网络层地址协商
* 数据压缩协商

#### PPP协议不需要的功能

* 纠错
* 流量控制
* 序号
* 多点线路
* 半双工或单工链路

#### PPP协议的组成

* 一个将IP数据包封装到串行链路中的方法。
* `链路控制协议LCP`
* `网络控制协议NCP`

### PPP的协议体系

* 采用高级数据链路控制协议HDLC作为点到点的串行链路上封装数据报的基本方法
* 采用链路控制协议LCP用于启动线路，测试、任选功能的协商及关闭连接
* 采用网络控制协议NCP来建立和配置不同的网络层协议，PPP允许同时采用多种网络层协议，PPP使用NCP对多种协议进行封装。

### PPP协议的帧格式

相比HDLC多了一个协议部分

协议的值

- 若为0x0021，则信息字段就是IP数据报
- 若为0x8021，则信息字段就是网络控制数据
- 若为0xC021，则信息字段就是PP链路控制数据
- 若为0xC023，则信息字段就是鉴别数据

当PPP用在同步传输链路时，协议规定采用硬件来完成比特填充（和HDLC的做法一样）。

当PPP在异步传输时，就是用一种特殊的字符填充法。

#### 零比特填充

PPP协议用在SONET/SDH链路时，使用同步传输，这时PPP协议采用零比特填充方法来实现透明传输。

### PPP协议的工作状态

* 当用户拨号接入ISP时，有路由器的调制解调器对拨号做出确认，并建立一条物理连接
* PC机向路由器发送一系列LCP分组（封装成多个PPP帧）
* 这些分组及其响应选择一些PPP参数，并进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机称为因特网上的主机。
* 通讯完毕时，NCP释放网络层连接，收回原来分配出去的IP地址，接着，LCP释放数据链路层连接，最后是放的是物理层的连接。
* 可见，PPP协议已经不是纯粹的数据链路层协议，他还包括了物理层何人网络层的内容

#### PPP会话建立的过程

PPP提供了建立，配置，维护，和终止点到点的连接方法，从开始发起呼唤到最终通信完成 后释放链路，PPP的工作分为以下4个阶段：

* 链路的建立和配置

  通信的发起方发送LCP帧来检测和配置数据链路，主要用于协商选了将要采用的PPP参数，包括身份验证、压缩、回叫、多链路等

* 链路质量的检测

  在链路建立，协调之后，这一阶段是可选的。

* 网络层协议配置协调

  通信的发起方发送NCP帧以选择并配置网络层协议，配置完成后，通信双方可以发送各自的网络层协议数据报。

* 关闭链路

  通信链路将一直保持LCP或NCP关闭链路，或是发生一些外部事件。

## 使用广播信道的数据链路层

数据链路层分为逻辑链路子层和介质访问子层

`LLC，逻辑链路控制子层`

`MAC，介质访问控制子层`

LLC和MAC子层的功能分解主要是讲数据链路层功能中与硬件有关的部分和与硬件无关的部分区分开来。

LLC帧和MAC帧的关系：

![Ppnhfs.png](https://s1.ax1x.com/2018/06/22/Ppnhfs.png)

* 逻辑链路子层的规范包含在IEEE802.2标准中。
* 这个标准与HJDLC使兼容的，但是使用的帧格式，有所不同，这是由于HDLC的标志和位填充技术不适合局域网，因此被排除，而且帧检验序列由MAC子层实现，因而也不包含在LLC的帧结构中
* 另外为了适合局域网的寻址，地址字段也有所改变，同时提供目标地址和源地址

#### LLC服务

* LLC与所在的局域网所采用的拓扑结构、传输介质，以及介质访问控制方式无关，它完成数据链路层管理、差错控制、流量控制，和数据帧顺序控制的功能，并未高层提供服务访问点。
* LLC提供三种服务：
  * 无确认连接服务
  * 连接方式服务
  * 有确认无连接的服务

#### LLC操作类型

LLC协议与HDLC协议类似，他们之间的差别如下：

* LLC使用`无编号信息帧`，支持无确认无连接的服务，这被称为LLC1型操作
* LLC用HDLC的`异步平衡方式`的操作来支持连接方式的LLC服务，这种操作类型被称为LLC2型操作，LLC不支持HDLC的其他操作
* LLC用一种新的无编号帧（AC）支持有确认无连接的服务，这被称为LLC3型操作

数据链路层的介质访问控制子层用来`解决广播信道的分配问题`，与之相应的用来`分配传输介质使用权限的协议称为MAC协议` 

以`太网的核心技术`就是他的`随机争用型介质访问方法`，即`CSMA/CD`介质访问控制方法。

以太网包括DIX以太网和IEEE802.3以太网两个标准

### 局域网的数据链路层

局域网最主要的特点是：

* 网络为一个单位所拥有
* 地理范围和站点数目均有限

局域网的优点：

* 具有广播功能
* 便于系统的扩展和逐渐地演变
* 提高系统可靠性，可用性，生存性

数据链路层的两个子层

* `逻辑链路控制子层LLC`
* `媒体接入控制子层MAC`

与接入到`传输媒体`有关的内容都放在`MAC子层`，而LLC子层则与传输媒体无关。

不论采用什么协议的局域网，对LLC子层来说都是透明的。

> 由于 TCP/IP 体系经常使用的局域网是 DIX Ethernet V2 而不是 802.3 标准中的几种局域网，因此现在 802 委员会制定的逻辑链路控制子层 LLC（即 802.2 标准）的作用已经不大了。 iS

**一般不考虑LLC子层**

网络接口板又称为`通信适配器`或`网络接口卡`NIC（Network Interface Card），或`网卡`

适配器的重要功能：

* 进行串行/并行转换
* 对数据进行缓存
* 在计算机的操作系统安装设备驱动程序
* 实现以太网协议

### CSMA/CD协议

为了渐变，以太网采取了两种重要的措施：

* 较为灵活地无连接的工作方式
  * 以太网提供的服务是不可靠的交付，即尽最大努力的交付
  * 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做，差错的纠正由高层来决定
  * 如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传帧，而是当作一个新的数据帧发送
* 以太网的数据都采用曼彻斯特编码
  * 曼彻斯特编码的缺点是：他所占的频带宽度比原始的基带信号增加了一倍

#### CSMA/CD协议

* 含义：载波监听多点接入/碰撞检测
* `多点接入`表示许多计算机以多点接入的方式连接在一根总线上
* `载波监听`是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机再发送数据，如果有，则暂时不要发送数据，以免发生碰撞。
* 总线上并没有什么载波，因此载波监听就是用电子技术检测总线上有没有其他计算机发送的数据信号。
* `碰撞检测`就是计算机边发送数据边检测信道上的幸好电压大小
* 当几个站同时在总线上发送数据时，总线上的信号电压摆动值就会增大，当一个站检测到信号嗲呀摆动值超过一定的门限值，就认为总线上至少有两个站同时在发送数据，表明发生了碰撞。
* 所谓碰撞就是发生了冲突。因此碰撞检测也称为冲突检测
* 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息
* 每一个再发送数据的站，一旦发现总线上出现了碰撞，就要立刻停止发送，免得浪费网络资源。然后等一段时间后再次发送
* 碰撞的结果是两个帧都变得无用

#### CSMA/CD的重要性

* 使用CSMA/CD检测协议的以太网不能进行全双工通信，而只能进行双向交替通信（半双工通信）
* 每个站在发送数据之后的一小短时间内，存在着遭遇碰撞的可能性
* 这种发送不确定型使整个以太网的平均通信量远小于以太网的最高数据率

#### 争用期

* 最先发送数据帧的站，再发送数据帧后至多经过时间2r，（两倍的端到端的往返时间）就可知道发送的数据帧是否遭受了碰撞
* 以太网的读研到短的往返时延2r称为`争用期`，或`碰撞窗口`。
* 经过争用期这段时间还没有检测到碰撞，才能肯定这次的发送不会发生碰撞

发生碰撞的站在停止发送数据之后要推迟一个随机时间才能再次发送数据，

**以太网在发送数据时，若前64字节没有发生冲突那么后续的数据就不会发生冲突**

强化碰撞：

* 当发送数据的站一旦发生了碰撞时，
  * 立即停止发送数据
  * 再继续发送若干比特的认为干扰信号，一边所有用户都知道现在已经发生了膨胀

#### CSMA/CD协议的要点

* 准备发送：但是在发送之前必须检测信道
* 检测信道：若检测到信道忙，则应该不停的检测，一直等到信道转为空闲，若检测到信道空闲，并在96比特时间内信道保持空闲，就发送这个帧
* 检查碰撞：在发送过程中仍不停地检测信道，即网络适配器要边发送边监听，这里有两种可能：
  * 发送成功：在争用期内一直未检测到碰撞，这个帧肯定能够发送成功。发送完毕后，其他什么都不做，然后退回1
  * 发送失败：在争用期内检测到碰撞，这事就立即停止发送数据，并按照规定发送认为干扰信号。适配器接着就执行指数退避算法，等待r倍512比特时间后，返回到步骤2，继续检测信道，若重传16次仍不能成功，则停止传播而向上报错。

#### 帧间最小间隔

一个站在检测到总线上空闲后，还要等待9.6微s才能再次发送数据。

### 使用集线器的星型拓扑

* 集线器：

![P9FuqJ.png](https://s1.ax1x.com/2018/06/23/P9FuqJ.png)

集线器，很像一个多接口的转发器，工作在物理层

### 以太网的信道利用率

帧长L，数据发送率位C，也帧的发送时间位L/C，成功发送一个帧需要的时间时T0+r，

要题告以太网的信道利用率，就必须减小r与T0之比，在以太网中定义参数a，他是以太网单程端到端时延r与帧的发送时间T0之比

a=r/T0

> a趋近于0，表示一发生碰撞就被检测出来，并立刻停止发送，因而信道利用率很高
>
> a越大，表明争用期所占的比例越大，每发生一次碰撞，就浪费许多信道资源，使得信道利用率明显降低。

对以太网a的要求是：

* r的数值不能太大，即以太网的连线长度受到限制
* T0的值不能太小，即以太网的帧长不能太短

#### 极限信道利用率

S=T0/(T0+r)=1/(1+a)；只有参数a远小于1才能的得到尽可能大的信道利用率。

### 以太网的MAC层

重点介绍：

* MAC层的硬件地址

  在局域网中，硬件地址又称为物理地址，或MAC地址，

  地址字段的第一个字节的最低位为I/G位。

  - 当I/G位=0时，地址字段表示一个单站地址
  - 当I/G位=1时，表示组地址，用来进行多播。

  所有48位都为1时，位广播地址。只能作为目的地址使用

  地址字段的第一字节的最低第2位规定为G/L位

  * =0时，是全球管理
  * =1时，是本地管理

  发往本站的帧分为三种：

  * 单波
  * 广播
  * 多播

  只有目的地址才能使用广播地址和多播地址

* MAC帧的格式

  ![](http://wx1.sinaimg.cn/mw690/0060lm7Tly1fsl72av8nxj30k8091aac.jpg)

  类型字段用来标志上一层使用的什么协议，以便将收到的MAC帧的数据上交给上一层的这个协议

  数据字段最小长度=最小长度64字节-18字节的首部和尾部=46字节

  数据字段：46-1500

  为达到比特同步，在传输媒体上实际传送的要比MAC帧多8个字节

  有效的MAC帧长度为64-1518

  对于检查出的无效的MAC帧，就简单的丢弃，以太网不负责重传丢弃的帧

## 扩展的以太网

### 在物理层扩展以太网

* 使用光纤扩展
* 使用集线器扩展

用集线器扩展以太网

* 优点
* 缺点
  * 碰撞增大了，但总的吞吐量并未提高

### 在数据链路层扩展以太网

扩展以太网更常用的方法是在数据链路层进行，早期使用网桥，现在使用以太网交换机。

以太网交换机的特点：

* 实质上就是一个多接口的网桥
* 每个接口都直接与一个单台主机或另一个以太网交换机相连接，并且一般都工作在全双工方式
* 以太网交换机具有并行性
* 相互通信的主机都御史独占传输媒体，无碰撞的传输数据
* 以太网交换机的接口有存储器，能在输出端口繁忙的时候把到来的帧进行缓存
* 以太网交换机是一种即插即用的设备，其内部的交换表是通过自学习算法自佛难过的逐渐建立起来的
* 以太网交换机使用了专门的交换机结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快得多

以太网交换机的交换方式：

* 存储转发
* 直通方式
  * 接受数据帧的同时，就立即按照数据帧的目的MAC地址决定帧的转发接口，因而提高了帧的转发速度
  * 缺点是他不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他站

#### 以太网交换机的自学习功能

* 以太网交换机运行学习算法自动维护交换表

* 开始时，以太网交换机里面的交换表是空的

  ![](http://wx2.sinaimg.cn/mw690/0060lm7Tly1fsl7ztupbtj30bc070gll.jpg  )

  * A先向B发送一帧，从接口1处进入交换机，
  * 交换机接收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧，
  * 交换机把这个帧的源地址A和接口1写入交换表中，并向除接口1以外的所有接口广播这个帧
  * C和D将丢弃这个帧，因为目的地址部队，只有B才会接收次啊这个目的地址正确的帧，这也称为过滤
  * 从新写入交换表的项目（A，1）可以看出，以后不管从哪一个接口接收到帧，只要其目的地址是A，就将收到的帧从接口1发出去
  * B 通过接口 3 向 A 发送一帧。
  * 交换机查找交换表，发现交换表中的 MAC 地址有 A。表明要发送给A的帧（即目的地址为 A 的帧）应从接口1转发。于是就把这个帧传送到接口 1 转发给 A。显然，现在已经没有必要再广播收到的帧。
  * 交换表这时新增加的项目 (B, 3)，表明今后如有发送给 B 的帧，就应当从接口 3 转发出去。
  * 经过一段时间后，只要主机 C 和 D 也向其他主机发送帧，以太网交换机中的交换表就会把转发到 C 或 D 应当经过的接口号（2 或 4）写入到交换表中。

考虑到有可能有时要在交换机的接口处更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目，为此，在交换表中的每个项目都有哟定的有效时间，过期的项目就会被自动删除

#### 交换机使用了生成树协议STP(Spanning Tree Protocol)。

#### 从总线以太网到星形以太网

* 以太网交换机不适用共享总线，因此没有碰撞问题，不适用CSMA/CD协议，而是以全双工方式工作但仍采用以太网的帧结构

### 虚拟局域网

* 使用以太网交换机可以很方便的实现虚拟局域网VLAN(Virtual LAN)
* 虚拟局域网只是局域网给用户提供的一种服务，而并不是一种新型局域网

VLAN的特点：

* 基于逻辑的分组
* 在同一个VLAN内和真实的局域网相同
* 不受物理位置的限制
* 减少节点在网络中移动带来的管理代价

VLAN具有的功能

* 控制网络广播，提高网络性能
* 分割网段，确保网络安全
* 简化网络管理，提高组网灵活性

#### 以太网的帧格式

![](http://wx1.sinaimg.cn/mw690/0060lm7Tly1fsl8vx85p8j30k409zq3n.jpg)

相比于MAC帧，多了4字节的VLAN标记

## 高速以太网

### 100BASE-T以太网

* 速率达到100M的以太网称为高速以太网、

100BASE-T以太网的特点：

* 可在全双工方式下工作而无冲突发生，不使用CSMA/CD协议
* 保持最短的帧长不变，但将一个网段的最大电缆长度减小到100米
* 帧时间间隔减小10倍

### 吉比特以太网

* 允许在 1 Gbit/s 下全双工和半双工两种方式工作。
* 使用 IEEE 802.3 协议规定的帧格式。
* 在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。
* 与 10BASE-T 和 100BASE-T 技术向后兼容。

吉比特以太网工作在半双工方式时，就必须进行碰撞检测

为保持64字节最小帧长度，以及100米的网段的最大长度，吉比特以太网增加了两个功能

* 载波延申

  最短帧长仍为64字节，同时将争用时间增大为512字节。

* 分组突发

### 10吉比特以太网和更快的以太网

### 使用以太网进行宽带接入

以太网宽带接入有一下特点：

* 可以提供双向的宽带通信
* 可以根据用户对宽带的需求灵活的进行宽带升级
* 可实现端到端的以太网传输，中间不需要在进行帧格式的转换，这就提高了数据的传输效率且降低了传输成本
* 但是不支持用户身份鉴别