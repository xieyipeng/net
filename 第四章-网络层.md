# 网络层

## 网络层提供的两种服务

* 网络层应该向运输层一共什么服务引起了长期的争议
* 争论焦点的实质就是：在计算机通信中，可靠的交付应当由谁来负责，时网络还是端系统
* 网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务
* 网络层不提供服务质量的承诺

## 网际协议IP

> 网际协议IP是TCP/IP协议体系中最重要的协议之一

与IP协议配套的协议还有三个：

* `地址解析协议ARP`
* `网际控制报文协议ICMP`
* `网际组管理协议IGMP`

### 虚拟互联网络

* 将网络互连起来需要使用一些中间设备
  * 物理层：转发器（中继系统）
  * 数据链路层：网桥或桥接器
  * 网络层：路由器
  * 网桥和路由器的混合物：桥路器
  * 网络层以上：网关
* 当中继系统是转发器或网桥时，一般不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍是一个网络
* 网关由于比较复杂，使用的较少
* 网络互连都是指用路由器进行网络互连和路由选择
* 许多有关TCP/IP的文献将网络层使用的路由器称为网关
* 所谓的虚拟互联网络也就是逻辑互联。他的意思就是互连起来的各种物理网络的异构性本来就是客观存在的，但我们利用IP协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络
* 使用IP协议的虚拟互联网络可简称为IP网
* 如果在这种覆盖全球的IP网的上层使用TCP协议，就是现在的互联网

### 分类的IP地址

在TCP/IP协议体系中，IP地址是一个最基本的概念

本章分重点学习：

* IP地址及其表示方法
* 常用的三种类别的IP地址

计算机互联的前提：标识与寻址

* MAC寻址
* IP寻址
* 计算机名-NetBIOS名称
* DNS-URL

要使Internet上主机能正常通信，必须给每个计算机一个全球都能接收和是别的唯一标识，即`IP地址`

* 我们把因特网看成一个单一的抽象的网络
* IP地址就是给每个连接在互联网上的主机分配一个全世界范围是唯一的32位标识符
* IP地址现在由互联网名字和数字分配机构进行分配

IP地址的编址方法：

* 分类的IP地址

  这是最基本的编址方法

* 子网的划分

  这是对最基本的编址方法的改进

* 构成超网

  这是比较新的无分类编址方法

分类IP地址：

* 将IP地址划分为若干个固定类
* 每一类地址都有两个固定长度的字段组成，其中一个字段是`网络号`，它标志主机所连结到的网络，另一个字段是`主机号`，他标志该主机
* 主机号在她前面的网络号所制定的范围内必须是唯一的
* 由此可见，一个IP地址在整个互联网范围内是唯一的

各类IP地址的网络号字段和主机号字段：

![](http://wx3.sinaimg.cn/mw690/0060lm7Tly1fsle1isehjj30jl0d374y.jpg)

点分十进制记法：

![](http://wx4.sinaimg.cn/mw690/0060lm7Tly1fsle38wuulj30jj0brwfh.jpg)

常用的三类IP地址：

![](http://wx3.sinaimg.cn/mw690/0060lm7Tly1fsle58djk1j30je080wez.jpg)

几种特殊的IP地址形式：

![](http://wx3.sinaimg.cn/mw690/0060lm7Tly1fsle7pan2ij30fb08zq3e.jpg)

IP地址的一些重要特点：

* IP地址是一种分等级的地址结构。分等级的好处：
  * IP地址管理机构在分配IP地址的时候值分配网络号，剩下的主机号则由得到该网络号的单位自行分配。方便管理IP地址
  * 路由器仅根据主机所连接的网络号转发分组，而不考虑主机号，这样可以使路由表中的项目数量大幅的减少，从而减小了路由表所占的存储空间
* 实际上IP地址是标志着一个主机和一条链路的接口
  * 连接到两个网络号的主机称为多归属主机
  * 一个路由器至少应当具有两个不同的IP地址
* 用转发器或网桥连接起来的若干局域网仍为一个网络，因此具有同样的网络号
* 所有分配到网络号的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的

### IP地址与硬件地址

IP地址和硬件地址是不同的地址，从层次的角度看：

* 硬件地址是数据链路层和物理层使用的地址
* IP地址是网络层和以上各层使用的地址，是一种逻辑地址，称IP地址是逻辑地址的原因是：IP地址是用软件实现的。

![](http://wx4.sinaimg.cn/mw690/0060lm7Tly1fslf2y2gpmj30jk0afwfb.jpg)

### 地址解析协议ARP

通信时使用了两个地址：

* IP地址
* MAC地址

地址解析协议的作用：

* 地址解析协议解决：已知一个机器的IP地址，如何找到其对应的硬件地址。

**不管网络层使用的什么协议，在实际网络的链路上传送帧时，最终还是必须使用硬件地址**

* ARP请求分组：包含发送后方硬件地址，发送方IP地址，目标方硬件地址，目标放IP地址
* 本地广播ARP请求，路由器不转发ARP请求
* ARP分组封装在物理层网络的帧中传输

ARP高速缓存的作用：

* 存放最近获得的IP地址到MAC地址的绑定，减少ARP广播数量

ARP是解决同一局域网上的主机或路由器的IP地址和硬件地址的映射问题

#### 反向地址解析协议RARP

实现物理地址到IP地址的转换

### IP数据报的格式

IP数据报由首部和数据两部分组成，首部的前一部分时固定长度，共20字节，是所有IP数据报必须具有的。

![](http://wx4.sinaimg.cn/mw690/0060lm7Tly1fslg9l82faj30jn0dhmy0.jpg)

* 数据报最大长度为65535字节
* 生存时间：记为TTL(Time To Live)，指示数据报在网络中能通过的路由器的最大数值
* IP协议支持多种协议，IP数据报可以封装多种协议PDU

IP数据报的可变部分

* 从1字节到40字节不等

### IP层转发分组的流程

* 查找路由表
* 特定主机路由
* 默认路由
* IP数据报的首部中没有地方可以指明下一跳路由器的IP地址
* 路由器分组转发算法

关于路由表：

* 路由表没有给分组指明到某个网络的完整路径
* 路由表指出，到某个网络，先到某个路由器

## 划分子网和构造超网

### 划分子网

* 从两级IP地址到三级IP地址

* IP地址中增加子网字段，使两级IP地址变成三级IP地址

* 这种做法叫做划分子网

  ![](http://wx1.sinaimg.cn/mw690/0060lm7Tly1fsm5dkfrmdj30cg03xt8m.jpg)

* 划分子网后变成了三级结构

优点：

* 减少IP地址的浪费
* 使网络的组织更加灵活
* 便于维护和管理

子网掩码：

* 从一个IP数据报的首部无法判断源主机或目的主机或目的主机是否进行了子网划分
* 使用子网掩码可以找出IP地址中的子网部分
* IP地址 `与` 子网掩码等于`网络地址`

子网划分：

* 固定长度子网
* 可变长子网

### 使用子网时分组的转发

### 无分类编址CIDR(构造超网)

特点：

* 消除传统的ABC类地址以及划分子网的概念，可以更有效地分配IPv4的地址空间
* IP地址由三级编址又回到了两级编址

无分类两级编址的记法：

![](http://wx4.sinaimg.cn/mw690/0060lm7Tly1fsm7dnlzc8j30h0056t8v.jpg)

> CIDR 使用“斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址后面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24 

路由聚合：

* 一个CIDR地址块可以表示很多地址，这种地址的聚合称为`路由聚合`
* 路由聚合也称`构成超网`
* 网络前缀的后面加一个星号 * 的表示方法，如 00001010 00*，在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值

构成超网：

* 前缀长度不超过23位的CIDR地址快都包含了多个C类地址，这些C类地址合起来就构成了超网

#### 最长前缀匹配

## 网际控制报文协议ICMP

* 更有效地转发IP数据报和提高交付成功的机会

* ICMP是互联网的标准协议

* ICMP报文装在IP数据报中，作为其中的数据部分

* ICMP不是高层协议，而是IP层协议

  ![](http://wx2.sinaimg.cn/mw690/0060lm7Tly1fsm81dcemlj30id0953yq.jpg)

### ICMP报文的种类

* ICMP报文有两种，即ICMP差错报告报文和ICMP询问报文
* ICMP差错报文共有4种
  * 终点不可达
  * 时间超过
  * 参数问题
  * 改变路由
* ICMP询问报文有两种
  * 回送请求和回答报文
  * 时间戳请求和回答报文

### ICMP的应用举例

## 互连网的路由选择协议

### 有关路由选择协议的几个基本概念

理想的路由选择算法：

关于最佳路由：

* 所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已

* 路由选择是个非常复杂的问题，它是网络中的所有结点共同协调工作的结果。路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。

* 从路由算法的自适应性考虑：

  * 静态路由选择策略：
  * 动态路由选择策略：

* 分层次的路由选择协议

* 自治系统AS

* 互联网有关的两大类路由选择协议

  * 内部网关协议IGP

    在一个自治系统内部使用的路由选择协议

  * 外部网关协议

    自治系统之间的路由选择协议

* 自治系统之间的路由选择叫做`域间路由选择`

* 自治系统内的路由选择叫做域内路由选择

### 内部网关协议RIP

* 工作原理

  * 路由选择协议RIP是内部网关协议IGP中最先得到广泛应用的协议
  * RIP是一种分布式的、基于距离向量的路由选择协议
  * 从一个路由器直接连接的网络的距离定义为1，RIP中的距离也称为跳数。
  * 距离指的是最短距离
  * RIP允许一条路径上最多只能包含15个路由器
  * 距离的最大值为16时即相当于不可达

* RIP协议的三个特点

  * 仅和相邻的路由器交换信息
  * 交换的信息时当前路由器所知道的全部信息，即自己的路由表
  * 按固定的时间间隔交换信息

* RIP2协议的报文格式

  ![](http://wx2.sinaimg.cn/mw690/0060lm7Tly1fsm8v9fgnsj30j40aeq3e.jpg)

  RIP2报文最多包括25个路由，因而RIP报文的最大长度时4+20*25=504字节

  RIP2报文具有简单的鉴别功能

* 好消息传播的快，坏消息传播的慢

* 优点：

  * 实现简单，开销较小

* 缺点：

  * RIP限制网络规模
  * 坏消息传播的慢

### 内部网关协议OSPF

OSPF：开放最短路径优先

SPF：Dijkstra提出的最短路径算法

* 采用分布式的链路状态协议

* 向本自治系统内所有路由器发送信息，这里使用的是洪泛法

* OSPF的更新过程收敛的快是其重要优点

* OSPF将一个自治系统在划分为若干个更小的范围，叫做区域

* OSPF划分为两种不同的区域

  * 主干区域
  * 区域

* OSPF不用UDP而是使用IP数据报传送

  ![](http://wx3.sinaimg.cn/mw690/0060lm7Tly1fsm9c3fra8j30j80dh0tj.jpg)

* OSPF5中分组类型

  * 问候分组
  * 数据库描述分组
  * 链路状态请求分组
  * 链路状态更新分组
  * 链路状态确认分组

### 外部网关协议BGP

BGP时不同自治系统的路由器之间交换路由信息的协议

* 每个自治系统的管理人员至少选择一个路由器作为该自治系统的BGP发言人

* 两个发言人要交换信息，首先要建立TCP连接，然后在此链接上交换BGP报文以建立BGP会话

* 特点：

  * BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多 
  * 每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。

* BGP共4种报文：

  * 打开
  * 更新
  * 保持
  * 通知

* BGP报文：

  ![](http://wx1.sinaimg.cn/mw690/0060lm7Tly1fsm9qmbm1aj30j708rglp.jpg)

### 路由器的构成

* 路由器是一种典型的网络层设备

* 路由器时互联网中的关键设备

* 路由器的主要作用是：

  * 联通不同的网络
  * 选择信息传送的线路

* 路由器的结构：

  * 路由器是一种具有多个输入端口和多个输出端口的专用计算机，`其任务是转发分组`。也就是说，将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。
  * 路由器的转发分组正式网络层的主要工作

* 典型的路由器结构可划分为两大部分：

  * 路由选择部分

    路由选择处理机的`任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表`。 

  * 分组转发部分

    分组转发部分由三部分组成：

    * 交换结构
    * 一组输入端口
    * 一组输出端口

* 路由表是根据路由选择算法得到的，而转发表是从路由表得到的

* 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。

* 交换结构

  * 交换结构是路由器的关键结构
  * 正是这个交换结构把分组从一个输入端口转移到某个适合的输出端口
  * 实现交换有很多方法，常用的交换方法有：
    * 通过存储器
    * 通过总线
    * 通过纵横交换结构

## IPv6

### IPv6的基本首部

* IP是互联网的核心协议
* IPv6支持无连接的传送，将协议数据单元PDU称为分组
* 引进的变化：
  * 更大的地址空间
  * 扩展的地址层次结构
  * 灵活的首部格式
  * 改进的选项
  * 允许协议继续扩充
  * 支持即插即用
  * 支持资源的预分配
  * IPv6将首部改为8字节对齐
* IPv6数据报由两大部分组成
  * 基本首部-固定的40字节，称为基本首部
  * 有效载荷

### IPv6的地址

- 单播
- 多播
- 任播：目的站是一组计算机，但数据报在交付时只交付其中的一个
- 冒号16进制记法：
  * 允许零压缩
  * 点分十进制记法的后缀
- IPv6的地址分类
  * 未指明地址
    * 16字节的全0地址
    * 这个地址只能为还没有配置到一个标准的IP地址的主机当作源地址使用
    * 这类地址仅此一个
  * 环回地址
    * 即0:0:0:0:0:0:0:1
    * 作用和IPv4的环回地址一样
    * 这类地址仅此一个
  * 多播地址
    * 占IPv6地址总数的1/256
  * 本地链路单播地址
    * 占IPv6地址总数的1/1024
  * 全球单播地址
    * IPv6的这一类单播地址是使用的最多的一类

### 从IPv4向IPv6过渡

* 向IPv6过度只能采用逐步演进的办法

* 两种向IPv6过去的策略：

  * 使用双协议栈

    双协议栈(dual stack)是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4 和一个 IPv6

  * 使用隧道技术

    在 IPv6 数据报要进入IPv4网络时，把 IPv6 数据报封装成为 IPv4 数据报，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。 

### ICMPv6

IPv6也不保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报；因此IPv6也需要使用ICMP来反馈一些差错信息

* 地址解析协议ARP和网际组管理协议IGMP协议的功能都被合并到ICMPv6中

## IP多播

### IP多播的基本概念

* 目的：更好的支持一对多通信
* 在互联网上进行多播就是IP多播
* 互联网范围内的多播主要靠路由器来实现
* 能运行多播协议的路由器称为多播路由器
* IP多播所传送的分组需要使用多播IP地址
* 在多播数据报的目的地址写入的是多播组的标识符
* 多播组的标识符就是IP地址中的D类地址
* 每个D类地址标志一个多播组
* 多播地址只能用于目的地址，不能用于源地址
* 多播数据报，不产生ICMP差错报文

### 在局域网上进行硬件多播

### 网际组管理协议IGMP和多播路由选择协议

* IP多播需要两种协议

  * IGMP

    IGMP协议是让连接在本地局域网上的多播路由器知道本剧于网上是否有主机参加或退出了某个多播组

  * 多播路由选择协议

* 多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络

* IGMP是整个网际协议IP的一个组成部分

* IGMP工作分为两个阶段：

  * 加入到多播组
  * 探询组成员变化情况

* 多播路由选择：

  * 实际上就是要找出以源主机为根节点的多传播转发树

  * 多播路由选择协议在转发多播数据报时使用三种方法：

    * 洪泛和剪除

      为了避免兜圈子，采用了叫做`反向路径广播RPB`的策略

      * 先检查是否从远点经最短路径传送过来
      * 若是，就像所有其他方向转发这条数据报，否则丢弃
      * 如果存在几条同样长度的最短路径，那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的 IP 地址最小。 
      * 最后得除用来转发多播数据报的多播转发树

    * 隧道技术

    * 基于核心的发现技术

## 虚拟专用网VPN和其他网络地址转换

### 虚拟专用网VPN

> 由于 IP 地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。
>
> 考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。
>
> 假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。

* 本地地址-尽在机构内部使用的IP地址
* 全球地址-全球唯一的IP地址

> 问题：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。

* 在互联网上的所有路由器，对目的地址是专用地址的数据报一律不进行转发

  ![](http://wx1.sinaimg.cn/mw690/0060lm7Tly1fsmd9gqrvwj30iy098gm9.jpg)

  采用这样的专用IP地址的互联网称为专用网或本地互联网

* 用隧道技术实现虚拟专用网

* 内联网和外联网

* 远程接入VPN

### 网络地址转换NAT

> 在专用网上使用专用地址的主机如何与互联网上的主机进行通信

(1) 再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。

(2) 采用网络地址转换 NAT。这是目前使用得最多的方法。

* NAT路由器上发生两次转换
  * 离开专用网时
  * 进入专用网时

> 为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。
>
> 使用端口号的 NAT 叫作网络地址与端口号转换NAPT (Network Address and Port Translation)，而不使用端口号的 NAT 就叫作传统的 NAT (traditional NAT)。

## 多协议标记交换MPLS

> IETF于1997年成立了 MPLS 工作组，开发出一种新的协议——多协议标记交换 MPLS (MultiProtocol Label Switching)。
>
> “多协议”表示在 MPLS 的上层可以采用多种协议，例如：IP，IPX；可以使用多种数据链路层协议，例如：PPP，以太网，ATM 等。
>
> “标记”是指每个分组被打上一个标记，根据该标记对分组进行转发。

* MPLS并没额有取代IP，而是最为一种IP增强技术，被广泛应用在互联网中
* MPLS特点：
  * 支持面向连接的服务质量
  * 支持流量工程，平衡网络负载
  * 有效的支持虚拟专用网VPN

### MPLS的工作原理

* 基本工作过程：
  * IP分组的转发
  * 采用硬件技术对打上标记的IP数据报进行转发就称为标记交换

> MPLS 域 (MPLS domain) 是指该域中有许多彼此相邻的路由器，并且所有的路由器都是支持 MPLS 技术的`标记交换路由器 LSR `(Label Switching Router)。
>
> LSR 同时具有`标记交换`和`路由选择`这两种功能，标记交换功能是为了快速转发，但在这之前LSR 需要使用路由选择功能构造转发表。

### MPLS首部的位置与格式

MPLS并不要求下层的网络都使用面向连接的技术

![](http://wx4.sinaimg.cn/mw690/0060lm7Tly1fsmdwex038j30iz09d0tc.jpg)

