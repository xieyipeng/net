# 第五章 运输层

## 运输层协议概述

### 进程之间的通信

从通信和信息处理的角度来看，`运输层`向它上面的应用层提供通信服务，他`属于面向通信部份的最高层，同时也是用户功能中的最底层`

当网络的边缘部分的两个主机使用网络的核心部分功能进行端到端的通信时，`只有位于网络边缘部分的主机协议栈才有运输层`，而网络核心部分中的路由器在转发分组时都只用到下三层的功能。

* 运输层的作用：
  * 逻辑通信的意思是，好像这样通信，但是事实上并非这样通信，
  * 从IP层来说，通信的两端是两台主机。
  * 严格的来讲，两台主机进行通信，就是两台主机中的应用程序互相通信
  * 从运输层的角度来看，通信的真正断电并不是主机，而是主机中的进程，也就是说，端到端的通信就是应用进程之间的通信。
* 网络层和运输层有明显的区别：
  * 网络层是为主机之间提供逻辑通信
  * 运输层为应用进程之间提供端到端的逻辑通信
* 运输层的作用：
  * 在一台主机中经常有多个进程同时分别和另一台主机中的多个应用进程通信
  * 这表明运输层有i个很重要的作用：复用和分用。
  * 根据应用程序的不同需求，运输层需要有两种不同的运输协议：即`面向连接的TCP`和`无连接的UDP`
* 基于端口的复用和分用功能
* 逻辑通信信道对上层的表现却因为运输层使用的协议而有很大的差别
  * 当运输层他采用TCP时，尽管下面的网络是不可靠的，但这种逻辑通信信道就相当于一条全双工的可靠通道
  * 当运输层采用无连接的UDP时，这种逻辑信道是一条不可靠的信道

### 运输层的两个主要协议

TCP/IP的运输层有两个主要协议：

* 用户数据报协议UDP
* 传输控制协议TCP

![](http://wx2.sinaimg.cn/mw690/0060lm7Tly1fsmirbtjarj3090062wee.jpg)

TCP与UDP：

* 两个对等的实体在通信时传送的数据单位叫做`运输协议数据单元TPDU`
* TCP传送的数据单位协议时TCP报文段
* UDP传送的数据单位时UDP报文或用户数据报

UDP：一种无连接的协议

* 提供无连接的服务
* 在传输之前不需要先建立连接
* 传输的数据单位协议是UDP报文或用户数据报
* 对方的运输曾在收到UDP报文后不需要给出任何确认

TCP：一种面向连接的协议

* 提供面向连接的服务
* 传送的数据单位协议时TCP报文段
* TCP不提供广播或多播服务
* 由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源。

> nTCP 报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道。但这样的信道却不知道究竟经过了哪些路由器，而这些路由器也根本不知道上面的运输层是否建立了 TCP 连接。

### 运输层的端口

* 运行在计算机中的进程使用进程标识符来表示的
* 但运行在应用层的各种应用进程却不应当让计算机操作系统指派他的进程标识符

> n为了使运行不同操作系统的计算机的应用进程能够互相通信，就必须用统一的方法对 TCP/IP 体系的应用进程进行标志。 

需要解决的问题：

> 由于进程的创建和撤销都是动态的，发送方几乎无法识别其他机器上的进程。
>
> 有时我们会改换接收报文的进程，但并不需要通知所有发送方。
>
> 我们往往需要利用目的主机提供的功能来识别终点，而不需要知道实现这个功能的进程。

* 解决这个问题的方法就是在运输层使用协议端口号，或简称端口

软件端口和硬件端口：

* 两个不同的概念
* 在协议栈层间的抽象的协议端口是软件端口
* 路由器或交换机上的端口是硬件端口
* 硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址

TCP/IP运输层端口：

* 端口用一个16位端口号进行标志
* 端口号只具有本地意义，即端口号只是为了标志本计算机中应用层中的各进程
* 在互联网中，不同计算机的相同端口号是没有联系的
* 计算机之间的联系：不仅要知道IP地址，更要知道对方的端口号（找到进程）

两大类端口号

* 服务器使用的端口号
  * 熟知端口  0—1023
  * 登记端口号
* 客户端使用的端口号
  * 又称为短暂端口号

## 用数据报协议UDP

### UDP概述

* UDP旨在IP的数据报服务之上增加了一点功能：
  * 复用和分用的功能
  * 差错检测的功能
* UDP特点：
  * 无连接的
  * 尽最大努力交付
  * 面向报文
  * UDP没有拥塞控制
  * 支持一对一，一对多，多对多交互通信
  * 首部开销小

面向报文的UDP

* 应用程序浇下来的报文，添加首部后就像下交付IP层，UDP对应用层交下来的报文，既不合并，也不拆分，保留边界
* 一次发送一个报文
* 一次交付一个完整的报文
* 应用程序必须选择合适大小的报文

### UDP的首部格式

![](http://wx2.sinaimg.cn/mw690/0060lm7Tly1fsmjzrfjr1j30gz0a40t5.jpg)

UDP基于端口的分用：

* 伪首部的作用仅仅是为了计算检验和

## 传输控制协议TCP概述

### TCP最主要特点

* TCP是面向连接的运输层协议

* 每一条TCP连接只能由两个端点，每一条TCP连接只能是点对点的（一对一）

* TCP提供可靠交付的服务

* TCP提供全双工通信

* 面向字节流：虽然应用程序和 TCP 的交互是一次一个数据块，但 TCP 把应用程序交下来的数据看成仅仅是一连串无结构的字节流。

* TCP不保证接收方应用程序所接收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系，但接受方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样

* TCP对连续的字节流进行分段，形成TCP报文段

* TCP连接是一条虚连接，而不是一条真正的物理连接，

* TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）

* TCP 可把太长的数据块划分短一些再传送。

  TCP 也可等待积累有足够多的字节后再构成报文段发送出去。 

### TCP的连接

* TCP把连接作为最基本的抽象
* `TCP 连接的端点不是主机，不是主机的IP 地址，不是应用进程，也不是运输层的协议端口`。TCP 连接的端点叫做套接字 (socket) 或插口。
* 端口号拼接到IP地址即构成了套接字
* TCP连接就是由协议软件所提供的一种抽象
* 同一个IP地址可以有不同的TCP连接
* 同一个端口号也可以出现在多个不同的TCP连接中

## 可靠传输的工作原理

必须使用一些可靠的传输协议，在不可靠的传输信道上实现可靠传输

### 停止等待协议

* 停止等待就是每发送完一个分组就停止发送，等对方确认后再发送下一分组
* 全双工通信的双方即使发送方又是接收方
* 出现差错，超时重传

确认丢失和确认迟到

* 确认丢失：

  若 B 所发送的对 M1 的确认丢失了，那么 A 在设定的超时重传时间内不能收到确认，但 A 并无法知道：是自己发送的分组出错、丢失了，或者 是 B 发送的确认丢失了。因此 A 在超时计时器到期后就要重传 M1。

  假定 B 又收到了重传的分组 M1。这时 B 应采取两个行动：

  * 第一，丢弃这个重复的分组 M1，不向上层交付。
  * 第二，向 A 发送确认。不能认为已经发送过确认就不再发送，因为 A 之所以重传 M1 就表示 A 没有收到对 M1 的确认。

* 确认迟到

**像上述的这种可靠传输协议常称为自动重传请求 ARQ  (Automatic Repeat reQuest)。意思是重传的请求是自动进行的，接收方不需要请求发送方重传某个出错的分组。**

停止等待协议的优点是简单，缺点是信道利用率太低

为了提高传输效率，发送方可以不使用低效率的停止等待协议，而是采用流水线传输。 

> n流水线传输就是发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认。这样可使信道上一直有数据不间断地传送。

### 连续ARQ协议

* 滑动窗口协议比较复杂，是TCP协议的精髓所在
* 连续ARQ协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置
* 累计确认：
  * 接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。 
* 后退N：
  * 如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。 

#### TCP可靠通信的具体实现：

* TCP每一端都必须设置两个窗口：发送窗口和接收窗口
* TCP的所有确认都是基于序号而不是基于报文段

## TCP报文段的首部格式

* TCP首部的最小长度是20字节

![](http://wx3.sinaimg.cn/mw690/0060lm7Tly1fsml0brgnmj30h50bh3z5.jpg)



## TCP可靠传输的实现

### 以字节为单位的滑动窗口

> 第一，A 的发送窗口并不总是和 B 的接收窗口一样大（因为有一定的时间滞后）。
>
> 第二，TCP 标准没有规定对不按序到达的数据应如何处理。通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程。
>
> 第三，TCP 要求接收方必须有累积确认的功能，这样可以减小传输开销。  

### 超时重传时间的选择

> TCP 采用了一种自适应算法，它记录一个报文段发出的时间，以及收到相应的确认的时间。这两个时间之差就是报文段的往返时间 RTT

新的RTTS  =  (1 - a)*(旧的RTTS)+a*(新的RTT样本)   

RTO = RTTS+4*RTTD

新的 RTTD = (1 - b)*(旧的RTTD)+b*|RTTs-新的RTT样本|

* 在计算平均往返时间 RTT 时，只要报文段重传了，就不采用其往返时间样本

### 选择确认SACK

> 问题：若收到的报文段无差错，只是未按序号，中间还缺少一些序号的数据，那么能否设法只传送缺少的数据而不重传已经正确到达接收方的数据？
>
> 答案是可以的。选择确认 SACK 
>   (Selective ACK) 就是一种可行的处理方法。

* 如果这些字节的序号都在接收窗口之内，那么接收方就先收下这些数据，但要把这些信息准确地告诉发送方，使发送方不要再重复发送这些已收到的数据。 

## TCP的流量控制

### 利用滑动窗口实现流量控制

* 流量控制 (flow control) 就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞。
* 利用滑动窗口机制可以很方便地在 TCP 连接上实现流量控制。

> B 向 A 发送了零窗口的报文段后不久，B 的接收缓存又有了一些存储空间。于是 B 向 A 发送了 rwnd = 400 的报文段。
>
> 但这个报文段在传送过程中丢失了。A 一直等待收到 B 发送的非零窗口的通知，而 B 也一直等待 A 发送的数据。
>
> 如果没有其他措施，这种互相等待的死锁局面将一直延续下去。
>
> 为了解决这个问题，TCP 为每一个连接设有一个持续计时器 (persistence timer)。

### TCP的传输效率

### 拥塞控制的一般原理

* 在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种现象称为拥塞 (congestion)。

> 如果一个路由器没有足够的缓存空间，它就会丢弃一些新到的分组。
>
> 但当分组被丢弃时，发送这一分组的源点就会重传这一分组，甚至可能还要重传多次。这样会引起更多的分组流入网络和被网络中的路由器丢弃。
>
> 可见拥塞引起的重传并不会缓解网络的拥塞，反而会加剧网络的拥塞。

* 拥塞控制就是防止过多的数据注入到网络中，使网络中的路由器或链路不致过载。
* 流量控制往往指点对点通信量的控制，是个端到端的问题（接收端控制发送端）。
* 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。 
* 开环控制方法就是在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。 
* 闭环控制方法是基于反馈环路的概念。属于闭环控制的有以下几种措施： 
  * (1) 监测网络系统以便检测到拥塞在何时、何处发生。
  * (2) 将拥塞发生的信息传送到可采取行动的地方。
  * (3) 调整网络系统的运行以解决出现的问题。

## TCP的拥塞控制方法

* TCP采用基于窗口的方法进行拥塞控制。该方法属于闭环控制方法

* TCP发送方维持一个拥塞窗口

  * 拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。
  * 发送端利用拥塞窗口根据网络的拥塞情况调整发送的数据量。
  * 所以，发送窗口大小不仅取决于接收方公告的接收窗口，还取决于网络的拥塞状况，所以真正的发送窗口值为：真正的发送窗口值 = Min(公告窗口值，拥塞窗口值) 

* TCP拥塞控制算法：

  * 慢开始 (slow-start)

    确定网络的负载能力

  * 拥塞避免 (congestion avoidance)

  * 快重传 (fast retransmit)

  * 快恢复 (fast recovery)

* 只要发送方判断网络出现拥塞

  * ssthresh = max(cwnd/2，2)
  * cwnd = 1
  * 执行慢开始算法

* 采用快重传FR (Fast Retransmission) 算法可以让发送方尽早知道发生了个别报文段的丢失。 

* 当发送端收到连续三个重复的确认时，由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，而是执行快恢复算法 FR (Fast Recovery) 算法：

  * (1) 慢开始门限 ssthresh = 当前拥塞窗口 cwnd / 2 ；
  * (2) 新拥塞窗口 cwnd = 慢开始门限 ssthresh ；
  * (3) 开始执行拥塞避免算法，使拥塞窗口缓慢地线性增大。 

### 主动队列管理AQM

* TCP 拥塞控制和网络层采取的策略有密切联系。
* 重传会使 TCP 连接的发送端认为在网络中发生了拥塞。于是在 TCP 的发送端就采取了拥塞控制措施，但实际上网络并没有发生拥塞。
* 网络层的策略对 TCP 拥塞控制影响最大的就是路由器的分组丢弃策略。
* 所谓“主动”就是不要等到路由器的队列长度已经达到最大值时才不得不丢弃后面到达的分组。这样就太被动了。应当在队列长度达到某个值得警惕的数值时（即当网络拥塞有了某些拥塞征兆时），就主动丢弃到达的分组
* AQM 可以有不同实现方法，其中曾流行多年的就是随机早期检测 RED (Random Early Detection)。

## TCP的运输连接管理

### TCP的连接建立

- 连接建立
  - (1) 要使每一方能够确知对方的存在。
  - (2) 要允许双方协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）。
  - (3) 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配。
  - TCP的连接的建立采用客户服务器方式
  - TCP 建立连接的过程叫做握手。
  - 握手需要在客户和服务器之间交换三个 TCP 报文段。称之为三报文握手。
  - 采用三报文握手主要是为了防止已失效的连接请求报文段突然又传送到了，因而产生错误。
- 数据传送
- 连接释放

### TCP的连接释放

- TCP 连接释放过程比较复杂。
- 数据传输结束后，通信的双方都可释放连接。
- TCP 连接释放过程是四报文握手。

### TCP的有限状态机

- 粗实线箭头表示对客户进程的正常变迁。
- 粗虚线箭头表示对服务器进程的正常变迁。
- 细线箭头表示异常变迁。 